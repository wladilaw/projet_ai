<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Générateur de Lettres de Motivation</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Raleway:100,400,700');
        
        body {
            background-image: url("https://images.unsplash.com/photo-1642804602092-4c08233bee90?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D");
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
            font-family: 'Raleway', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .navbar {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .navbar h1 {
            color: white;
            margin: 0;
            font-size: 20px;
        }
        
        .navbar-links {
            display: flex;
            gap: 15px;
        }
        
        .navbar-links a {
            color: white;
            text-decoration: none;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .navbar-links a:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background-color: rgba(30, 50, 80, 0.8); /* Fond bleu foncé semi-transparent */
            color: white; /* Texte en blanc */
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .admin-header h2 {
            margin: 0;
            color: #333;
        }
        
        .admin-header .admin-actions {
            display: flex;
            gap: 10px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #D46836;
            border: 1px solid #D46836;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;  
            transition: background-color 0.3s;
        }
        
        .tab.active {
            background-color: #D46836;
            color: rgb(0, 0, 0);
            border-color: #D46836;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .users-table th, .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .users-table th {
            background-color: rgba(40, 60, 90, 0.7);
    color: rgb(0, 0, 0);

        }
        
        .users-table tr:hover {
            background-color: rgba(50, 70, 100, 0.7);
        }
        
        .users-table .actions {
            display: flex;
            gap: 5px;
        }
        
        .btn {
            background-color: #D46836;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #C14E26;
        }
        
        .btn.secondary {
            background-color: #6c757d;
        }
        
        .btn.danger {
            background-color: #dc3545;
        }
        
        .btn.success {
            background-color: #28a745;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-bar input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Raleway', sans-serif;
        }
        
        .user-details {
            padding: 20px;
            background-color: rgba(50, 70, 100, 0.7);
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .user-details h3 {
            margin-top: 0;
            border-bottom: 1px solid #0066ff;
            padding-bottom: 10px;
            color: #333;
        }
        
        .user-details .detail-row {
            display: flex;
            margin-bottom: 10px;
        }
        
        .user-details .detail-label {
            width: 150px;
            font-weight: bold;
        }
        
        .user-details .detail-value {
            flex-grow: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: rgb(255, 255, 255);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .stat-card .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #D46836;
            margin: 10px 0;
        }
        
        .stat-card .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
        
        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .modal-header h3 {
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Raleway', sans-serif;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge.premium {
            background-color: gold;
            color: #333;
        }
        
        .badge.free {
            background-color: #6c757d;
            color: white;
        }
        
        .flash-message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        
        .flash-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .flash-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .settings-form {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .toggle-switch {
            display: inline-block;
            position: relative;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #D46836;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .setting-info {
            flex-grow: 1;
        }
        
        .setting-info h4 {
            margin: 0 0 5px 0;
        }
        
        .setting-info p {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>Panneau d'Administration</h1>
        <div class="navbar-links">
            <a href="index.html">Retour au site</a>
            <a href="#" id="logoutLink">Déconnexion</a>
        </div>
    </div>
    
    <div class="container">
        <div id="flashMessage" class="flash-message"></div>
        
        <div class="admin-header">
            <h2>Administration du Générateur de Lettres</h2>
            <div class="admin-actions">
                <button id="createUserBtn" class="btn">Nouvel utilisateur</button>
                <button id="refreshBtn" class="btn secondary">Actualiser</button>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="users">Utilisateurs</div>
            <div class="tab" data-tab="stats">Statistiques</div>
            <div class="tab" data-tab="settings">Paramètres</div>
        </div>
        
        <div class="tab-content active" id="usersTab">
            <div class="search-bar">
                <input type="text" id="searchUsers" placeholder="Rechercher par nom ou email...">
                <button class="btn" id="searchBtn">Rechercher</button>
            </div>
            
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Date d'inscription</th>
                        <th>Statut</th>
                        <th>Jetons</th>
                        <th>Lettres générées</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Les utilisateurs seront ajoutés ici dynamiquement -->
                </tbody>
            </table>
            
            <div id="userDetails" class="user-details" style="display: none;">
                <!-- Les détails de l'utilisateur sélectionné seront affichés ici -->
            </div>
        </div>
        
        <div class="tab-content" id="statsTab">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Utilisateurs inscrits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="premiumUsers">0</div>
                    <div class="stat-label">Utilisateurs premium</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalLetters">0</div>
                    <div class="stat-label">Lettres générées</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenue">0€</div>
                    <div class="stat-label">Revenus totaux</div>
                </div>
            </div>
            
            <h3>Activité récente</h3>
            <div class="chart-container">
                <p>Graphique d'activité à implémenter ultérieurement</p>
            </div>
        </div>
        
        <div class="tab-content" id="settingsTab">
            <div class="settings-form">
                <h3>Paramètres généraux</h3>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Nombre d'essais gratuits</h4>
                        <p>Définir le nombre d'utilisations gratuites avant de demander un paiement</p>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="freeTrials" min="0" max="100" value="5">
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Mode maintenance</h4>
                        <p>Activer le mode maintenance pour effectuer des mises à jour</p>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="maintenanceMode">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <h4>Prix des formules</h4>
                        <p>Modifier les prix des différentes formules</p>
                    </div>
                    <div class="setting-control">
                        <button id="editPricesBtn" class="btn">Modifier</button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button id="saveSettingsBtn" class="btn">Enregistrer les paramètres</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal pour créer/modifier un utilisateur -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Nouvel utilisateur</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label for="userName">Nom</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">Mot de passe</label>
                    <input type="password" id="userPassword" placeholder="Laisser vide pour ne pas modifier">
                </div>
                <div class="form-group">
                    <label for="userStatus">Statut</label>
                    <select id="userStatus">
                        <option value="free">Essai gratuit</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userTokens">Jetons</label>
                    <input type="number" id="userTokens" min="-1" value="0">
                    <small>Utilisez -1 pour un nombre illimité de jetons</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn secondary close-modal-btn">Annuler</button>
                    <button type="submit" class="btn" id="saveUserBtn">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Variables globales
        let users = [];
        let appSettings = {
            freeTrials: 5,
            maintenanceMode: false,
            prices: {
                basic: 1.00,
                standard: 4.99,
                premium: 9.99,
                unlimited: 19.99
            }
        };
        
        // Fonction pour vérifier si l'utilisateur actuel est un administrateur
        function checkAdminAccess() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Vérifier si l'utilisateur est connecté et est un administrateur
            if (!currentUser.nom || currentUser.role !== 'admin') {
                // Rediriger vers la page d'accueil avec un message d'erreur
                localStorage.setItem('flashMessage', JSON.stringify({
                    type: 'error',
                    message: 'Accès non autorisé. Vous devez être administrateur pour accéder à cette page.'
                }));
                window.location.href = 'index.html';
                return false;
            }
            
            return true;
        }
        
        // Fonction pour afficher un message flash
        function showFlashMessage(message, type) {
            const flashElement = document.getElementById('flashMessage');
            flashElement.textContent = message;
            flashElement.className = 'flash-message flash-' + type;
            flashElement.style.display = 'block';
            
            // Faire disparaître le message après 3 secondes
            setTimeout(() => {
                flashElement.style.display = 'none';
            }, 3000);
        }
        
        // Fonction pour charger tous les utilisateurs depuis le localStorage
        function loadUsers() {
            users = [];
            const storedUsers = JSON.parse(localStorage.getItem('users') || '[]');
            
            // Pour chaque utilisateur, calculer des statistiques supplémentaires
            storedUsers.forEach(user => {
                // Calculer le nombre de lettres générées
                const lettersCount = user.lettersHistory ? user.lettersHistory.length : 0;
                
                // Ajouter l'utilisateur avec les statistiques
                users.push({
                    ...user,
                    lettersCount
                });
            });
            
            return users;
        }
        
        // Fonction pour afficher les utilisateurs dans le tableau
        function displayUsers(usersToDisplay = users) {
            const tableBody = document.getElementById('usersTableBody');
            tableBody.innerHTML = '';
            
            if (usersToDisplay.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" style="text-align: center;">Aucun utilisateur trouvé</td>';
                tableBody.appendChild(row);
                return;
            }
            
            usersToDisplay.forEach(user => {
                const row = document.createElement('tr');
                
                // Formater la date d'inscription
                const inscriptionDate = user.dateInscription ? new Date(user.dateInscription).toLocaleDateString('fr-FR') : '-';
                
                // Déterminer le statut (premium ou essai gratuit)
                const isPremium = user.premium || user.tokens === -1;
                const statusBadge = isPremium ? 
                    '<span class="badge premium">Premium</span>' : 
                    '<span class="badge free">Essai gratuit</span>';
                
                // Afficher le nombre de jetons (∞ pour illimité)
                const tokens = user.tokens === -1 ? '∞' : (user.tokens || 0);
                
                row.innerHTML = `
                    <td>${user.nom}</td>
                    <td>${user.email}</td>
                    <td>${inscriptionDate}</td>
                    <td>${statusBadge}</td>
                    <td>${tokens}</td>
                    <td>${user.lettersCount}</td>
                    <td class="actions">
                        <button class="btn view-user" data-id="${user.email}">Voir</button>
                        <button class="btn edit-user" data-id="${user.email}">Modifier</button>
                        <button class="btn danger delete-user" data-id="${user.email}">Supprimer</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Ajouter les événements aux boutons
            attachUserActionEvents();
        }
        
        // Fonction pour attacher les événements aux boutons d'action des utilisateurs
        function attachUserActionEvents() {
            // Bouton Voir
            document.querySelectorAll('.view-user').forEach(button => {
                button.addEventListener('click', function() {
                    const email = this.getAttribute('data-id');
                    viewUser(email);
                });
            });
            
            // Bouton Modifier
            document.querySelectorAll('.edit-user').forEach(button => {
                button.addEventListener('click', function() {
                    const email = this.getAttribute('data-id');
                    editUser(email);
                });
            });
            
            // Bouton Supprimer
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', function() {
                    const email = this.getAttribute('data-id');
                    deleteUser(email);
                });
            });
        }
        
        // Fonction pour afficher les détails d'un utilisateur
        function viewUser(email) {
            const user = users.find(u => u.email === email);
            if (!user) return;
            
            const userDetails = document.getElementById('userDetails');
            
            // Formater la date d'inscription
            const inscriptionDate = user.dateInscription ? new Date(user.dateInscription).toLocaleDateString('fr-FR') : '-';
            
            // Déterminer le statut (premium ou essai gratuit)
            const isPremium = user.premium || user.tokens === -1;
            const statusBadge = isPremium ? 
                '<span class="badge premium">Premium</span>' : 
                '<span class="badge free">Essai gratuit</span>';
            
            // Afficher le nombre de jetons (∞ pour illimité)
            const tokens = user.tokens === -1 ? '∞' : (user.tokens || 0);
            
            // Générer le HTML pour l'historique des paiements
            let paymentsHistory = '<p>Aucun paiement enregistré</p>';
            if (user.payments && user.payments.length > 0) {
                paymentsHistory = '<ul>';
                user.payments.forEach(payment => {
                    const paymentDate = new Date(payment.date).toLocaleDateString('fr-FR');
                    paymentsHistory += `<li>${paymentDate} - ${payment.planName} (${payment.amount.toFixed(2)}€)</li>`;
                });
                paymentsHistory += '</ul>';
            }
            
            // Générer le HTML pour l'historique des lettres
            let lettersHistory = '<p>Aucune lettre générée</p>';
            if (user.lettersHistory && user.lettersHistory.length > 0) {
                lettersHistory = '<ul>';
                user.lettersHistory.slice(0, 5).forEach(letter => {
                    const letterDate = new Date(letter.date).toLocaleDateString('fr-FR');
                    lettersHistory += `<li>${letterDate} - ${letter.entreprise} (${letter.poste || '-'})</li>`;
                });
                if (user.lettersHistory.length > 5) {
                    lettersHistory += `<li>... et ${user.lettersHistory.length - 5} autres lettres</li>`;
                }
                lettersHistory += '</ul>';
            }
            
            userDetails.innerHTML = `
                <h3>Détails de l'utilisateur</h3>
                <div class="detail-row">
                    <div class="detail-label">Nom:</div>
                    <div class="detail-value">${user.nom}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Email:</div>
                    <div class="detail-value">${user.email}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Inscription:</div>
                    <div class="detail-value">${inscriptionDate}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Statut:</div>
                    <div class="detail-value">${statusBadge}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Jetons:</div>
                    <div class="detail-value">${tokens}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Lettres générées:</div>
                    <div class="detail-value">${user.lettersCount}</div>
                </div>
                
                <h4>Historique des paiements</h4>
                ${paymentsHistory}
                
                <h4>Dernières lettres générées</h4>
                ${lettersHistory}
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn edit-user" data-id="${user.email}">Modifier</button>
                    <button class="btn close-details">Fermer</button>
                </div>
            `;
            
            // Afficher les détails
            userDetails.style.display = 'block';
            
            // Ajouter les événements aux boutons
            userDetails.querySelector('.edit-user').addEventListener('click', function() {
                const email = this.getAttribute('data-id');
                editUser(email);
            });
            
            userDetails.querySelector('.close-details').addEventListener('click', function() {
                userDetails.style.display = 'none';
            });
            
            // Faire défiler jusqu'aux détails
            userDetails.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Fonction pour ouvrir le modal en mode édition
        function editUser(email) {
            const user = users.find(u => u.email === email);
            if (!user) return;
            
            // Remplir le formulaire avec les données de l'utilisateur
            document.getElementById('userId').value = user.email;
            document.getElementById('userName').value = user.nom;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPassword').value = '';
            document.getElementById('userStatus').value = user.premium || user.tokens === -1 ? 'premium' : 'free';
            document.getElementById('userTokens').value = user.tokens === undefined ? 0 : user.tokens;
            
            // Mettre à jour le titre du modal
            document.getElementById('modalTitle').textContent = 'Modifier l\'utilisateur';
            
            // Afficher le modal
            document.getElementById('userModal').style.display = 'flex';
        }
        
        // Fonction pour supprimer un utilisateur
        function deleteUser(email) {
            if (!confirm(`Êtes-vous sûr de vouloir supprimer l'utilisateur avec l'email ${email} ?`)) {
                return;
            }
            
            // Récupérer tous les utilisateurs
            let storedUsers = JSON.parse(localStorage.getItem('users') || '[]');
            
            // Filtrer pour retirer l'utilisateur à supprimer
            storedUsers = storedUsers.filter(user => user.email !== email);
            
            // Sauvegarder les utilisateurs mis à jour
            localStorage.setItem('users', JSON.stringify(storedUsers));
            
            // Recharger et afficher les utilisateurs
            users = loadUsers();
            displayUsers();
            
            // Masquer les détails de l'utilisateur s'ils sont affichés
            document.getElementById('userDetails').style.display = 'none';
            
            // Afficher un message de succès
            showFlashMessage(`L'utilisateur ${email} a été supprimé avec succès.`, 'success');
        }
        
        // Fonction pour créer un nouvel utilisateur
        function createUser() {
            // Réinitialiser le formulaire
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userStatus').value = 'free';
            document.getElementById('userTokens').value = '0';
            
            // Mettre à jour le titre du modal
            document.getElementById('modalTitle').textContent = 'Nouvel utilisateur';
            
            // Afficher le modal
            document.getElementById('userModal').style.display = 'flex';
        }
        
        // Fonction pour sauvegarder un utilisateur (nouveau ou existant)
        function saveUser(event) {
            event.preventDefault();
            
            // Récupérer les valeurs du formulaire
            const userId = document.getElementById('userId').value;
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const status = document.getElementById('userStatus').value;
            let tokens = parseInt(document.getElementById('userTokens').value);
            
            // Validation des champs obligatoires
            if (!name || !email) {
                showFlashMessage('Le nom et l\'email sont obligatoires.', 'error');
                return;
            }
            
            // Vérifier que les jetons sont valides
            if (isNaN(tokens)) {
                tokens = 0;
            }
            
            // Récupérer tous les utilisateurs
            let storedUsers = JSON.parse(localStorage.getItem('users') || '[]');
            
            if (userId) {
                // Mode édition - Mettre à jour un utilisateur existant
                const userIndex = storedUsers.findIndex(user => user.email === userId);
                
                if (userIndex === -1) {
                    showFlashMessage(`Utilisateur avec l'email ${userId} non trouvé.`, 'error');
                    return;
                }
                
                // Mettre à jour les données de l'utilisateur
                const updatedUser = {
                    ...storedUsers[userIndex],
                    nom: name,
                    email: email
                };
                
                // Mettre à jour le mot de passe uniquement s'il est fourni
                if (password) {
                    updatedUser.password = password;
                }
                
                // Mettre à jour le statut premium
                updatedUser.premium = status === 'premium';
                
                // Mettre à jour les jetons
                updatedUser.tokens = tokens;
                
                // Si l'email a changé, c'est un nouvel identifiant
                if (email !== userId) {
                    // Supprimer l'ancien utilisateur
                    storedUsers = storedUsers.filter(user => user.email !== userId);
                    
                    // Ajouter le nouvel utilisateur avec le nouvel email
                    storedUsers.push(updatedUser);
                } else {
                    // Mettre à jour l'utilisateur existant
                    storedUsers[userIndex] = updatedUser;
                }
                
                // Vérifier aussi si c'est l'utilisateur actuellement connecté
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.email === userId) {
                    // Mettre à jour les données de l'utilisateur connecté
                    currentUser.nom = name;
                    currentUser.email = email;
                    if (password) currentUser.password = password;
                    currentUser.premium = status === 'premium';
                    currentUser.tokens = tokens;
                    
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                
                showFlashMessage(`L'utilisateur ${name} a été mis à jour avec succès.`, 'success');
            } else {
                // Mode création - Créer un nouvel utilisateur
                
                // Vérifier si l'email existe déjà
                if (storedUsers.some(user => user.email === email)) {
                    showFlashMessage(`Un utilisateur avec l'email ${email} existe déjà.`, 'error');
                    return;
                }
                
                // Validation du mot de passe
                if (!password) {
                    showFlashMessage('Le mot de passe est obligatoire pour un nouvel utilisateur.', 'error');
                    return;
                }
                
                // Créer le nouvel utilisateur
                const newUser = {
                    nom: name,
                    email: email,
                    password: password,
                    dateInscription: new Date().toISOString(),
                    premium: status === 'premium',
                    tokens: tokens,
                    lettersHistory: []
                };
                
                // Ajouter le nouvel utilisateur
                storedUsers.push(newUser);
                
                showFlashMessage(`L'utilisateur ${name} a été créé avec succès.`, 'success');
            }
            
            // Sauvegarder les utilisateurs mis à jour
            localStorage.setItem('users', JSON.stringify(storedUsers));
            
            // Fermer le modal
            document.getElementById('userModal').style.display = 'none';
            
            // Recharger et afficher les utilisateurs
            users = loadUsers();
            displayUsers();
            
            // Mettre à jour les statistiques
            updateStats();
        }
        
        // Fonction pour mettre à jour les statistiques
        function updateStats() {
            // Calculer les statistiques des utilisateurs
            const totalUsers = users.length;
            const premiumUsers = users.filter(user => user.premium || user.tokens === -1).length;
            
            // Calculer le nombre total de lettres générées
            let totalLetters = 0;
            users.forEach(user => {
                if (user.lettersHistory) {
                    totalLetters += user.lettersHistory.length;
                }
            });
            
            // Calculer les revenus totaux (à partir de l'historique des paiements)
            let totalRevenue = 0;
            users.forEach(user => {
                if (user.payments) {
                    user.payments.forEach(payment => {
                        totalRevenue += payment.amount;
                    });
                }
            });
            
            // Mettre à jour l'affichage des statistiques
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('premiumUsers').textContent = premiumUsers;
            document.getElementById('totalLetters').textContent = totalLetters;
            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2) + '€';
        }
        
        // Fonction pour charger les paramètres de l'application
        function loadSettings() {
            const storedSettings = localStorage.getItem('appSettings');
            if (storedSettings) {
                try {
                    appSettings = JSON.parse(storedSettings);
                } catch (e) {
                    console.error('Erreur lors du chargement des paramètres:', e);
                }
            }
            
            // Mettre à jour l'interface avec les paramètres
            document.getElementById('freeTrials').value = appSettings.freeTrials;
            document.getElementById('maintenanceMode').checked = appSettings.maintenanceMode;
        }
        
        // Fonction pour sauvegarder les paramètres de l'application
        function saveSettings() {
            // Récupérer les valeurs des paramètres
            const freeTrials = parseInt(document.getElementById('freeTrials').value);
            const maintenanceMode = document.getElementById('maintenanceMode').checked;
            
            // Mettre à jour les paramètres
            appSettings.freeTrials = freeTrials;
            appSettings.maintenanceMode = maintenanceMode;
            
            // Sauvegarder les paramètres
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
            
            showFlashMessage('Les paramètres ont été enregistrés avec succès.', 'success');
        }
        
        // Fonction pour rechercher des utilisateurs
        function searchUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayUsers(users);
                return;
            }
            
            // Filtrer les utilisateurs selon le terme de recherche
            const filteredUsers = users.filter(user => {
                return user.nom.toLowerCase().includes(searchTerm) || 
                       user.email.toLowerCase().includes(searchTerm);
            });
            
            displayUsers(filteredUsers);
        }
        
        // Fonction pour créer un utilisateur admin s'il n'existe pas
        function createAdminIfNotExists() {
            const storedUsers = JSON.parse(localStorage.getItem('users') || '[]');
            const adminExists = storedUsers.some(user => user.role === 'admin');
            
            if (!adminExists) {
                // Créer un administrateur par défaut
                const admin = {
                    nom: 'Administrateur',
                    email: 'admin@admin.com',
                    password: 'admin123',
                    role: 'admin',
                    premium: true,
                    tokens: -1,
                    dateInscription: new Date().toISOString(),
                    lettersHistory: []
                };
                
                storedUsers.push(admin);
                localStorage.setItem('users', JSON.stringify(storedUsers));
                
                showFlashMessage('Un compte administrateur a été créé: admin@admin.com / admin123', 'success');
            }
        }
        
        // Initialisation au chargement de la page
        $(document).ready(function() {
            // Vérifier si l'utilisateur a accès à l'espace admin
            if (!checkAdminAccess()) {
                // La redirection est gérée dans checkAdminAccess
                return;
            }
            
            // Créer un admin par défaut si nécessaire
            createAdminIfNotExists();
            
            // Charger les utilisateurs
            users = loadUsers();
            displayUsers();
            
            // Charger les paramètres
            loadSettings();
            
            // Mettre à jour les statistiques
            updateStats();
            
            // Navigation entre les onglets
            $(".tab").click(function() {
                $(".tab").removeClass("active");
                $(".tab-content").removeClass("active").hide();
                
                $(this).addClass("active");
                $("#" + $(this).data("tab") + "Tab").addClass("active").show();
            });
            
            // Recherche d'utilisateurs
            $("#searchBtn").click(searchUsers);
            
            // Recherche avec Entrée
            $("#searchUsers").keypress(function(e) {
                if (e.which === 13) {
                    searchUsers();
                }
            });
            
            // Bouton Nouvel utilisateur
            $("#createUserBtn").click(createUser);
            
            // Bouton Actualiser
            $("#refreshBtn").click(function() {
                users = loadUsers();
                displayUsers();
                updateStats();
                showFlashMessage('Les données ont été actualisées.', 'success');
            });
            
            // Bouton Déconnexion
            $("#logoutLink").click(function(e) {
                e.preventDefault();
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
            
            // Fermer le modal
            $(".close-modal, .close-modal-btn").click(function() {
                document.getElementById('userModal').style.display = 'none';
            });
            
            // Soumission du formulaire utilisateur
            $("#userForm").submit(saveUser);
            
            // Sauvegarder les paramètres
            $("#saveSettingsBtn").click(saveSettings);
            
            // Empêcher la fermeture du modal lors du clic à l'intérieur
            $(".modal-content").click(function(e) {
                e.stopPropagation();
            });
            
            // Fermer le modal en cliquant à l'extérieur
            $(".modal").click(function() {
                $(this).css('display', 'none');
            });
        });
    </script>
</body>
</html>